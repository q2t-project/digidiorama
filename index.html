<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Digidiorama Viewer v2</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml;utf8,
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <circle cx='50' cy='50' r='45' stroke='black' stroke-width='5' fill='white'/>
        <text x='50' y='60' font-size='50' text-anchor='middle' fill='black'>D</text>
      </svg>">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #container { display: flex; height: 100%; }
    #leftPanel, #rightPanel {
      width: 200px; overflow-y: auto; background: #f0f0f0; padding: 8px;
    }
    #viewer { flex: 1; background: #000; }
    header { display: flex; align-items: center; gap: 8px; padding: 4px; background: #ddd; }
    footer { padding: 4px; background: #eee; font-size: 12px; text-align: center; }
    button { margin-right: 4px; }
    .label {
      font-size: 12px;
      color: white;
      -webkit-text-stroke: 2px black;
      text-stroke: 2px black;
      white-space: nowrap;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <header>
    <input type="file" id="fileInput">
    <input type="text" id="urlInput" placeholder="Enter JSON URL">
    <button id="loadUrl">Load</button>
    <button id="resetBtn">Reset</button>
    <button id="fitBtn">Fit</button>
  </header>
  <div id="container">
    <div id="leftPanel">
      <h3>Meta</h3>
      <pre id="metaInfo"></pre>
    </div>
    <div id="viewer"></div>
    <div id="rightPanel">
      <h3>Layers</h3>
      <div id="layers"></div>
    </div>
  </div>
  <footer>
    schema v2 • 2025-09-25
  </footer>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { CSS2DRenderer, CSS2DObject } from "three/addons/renderers/CSS2DRenderer.js";

    const container = document.getElementById("viewer");
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(container.clientWidth, container.clientHeight);
    labelRenderer.domElement.style.position = "absolute";
    labelRenderer.domElement.style.top = 0;
    container.appendChild(labelRenderer.domElement);

    const controls = new OrbitControls(camera, labelRenderer.domElement);
    camera.position.set(0,0,100);
    controls.update();

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(1,1,1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    let graph = {nodes:[], edges:[]};

    function makeLabelPlane(text, attr={}) {
      const div = document.createElement("div");
      div.className = "label";
      div.textContent = text;
      if(attr.background){
        div.style.background = attr.background;
      }
      const label = new CSS2DObject(div);
      return label;
    }

    function loadJSON(data){
      graph = data;
      // counts表示
      const metaInfo = document.getElementById("metaInfo");
      const counts = `Nodes: ${data.nodes.length}\nEdges: ${data.edges.length}`;
      metaInfo.textContent = JSON.stringify(data.meta, null, 2) + "\n" + counts;

      // clear scene except lights
      [...scene.children].forEach(o=>{
        if(!(o.isLight)) scene.remove(o);
      });

      const nodeMap = new Map();
      data.nodes.forEach(n=>{
        const geom = new THREE.SphereGeometry(1.5,16,16);
        const mat = new THREE.MeshPhongMaterial({color:0x3399ff});
        const mesh = new THREE.Mesh(geom,mat);
        mesh.position.set(...n.pos);
        scene.add(mesh);

        if(n.label){
          const label = makeLabelPlane(n.label, n.labelAttr||{});
          label.position.copy(mesh.position).add(new THREE.Vector3(2,2,0));
          scene.add(label);
        }
        nodeMap.set(n.id, mesh);
      });

      data.edges.forEach(e=>{
        const src = nodeMap.get(e.source);
        const tgt = nodeMap.get(e.target);
        if(src && tgt){
          const pts = [src.position, tgt.position];
          const geom = new THREE.BufferGeometry().setFromPoints(pts);
          const mat = new THREE.LineBasicMaterial({color:0x999999});
          const line = new THREE.Line(geom, mat);
          scene.add(line);
        }
      });
    }

    // File input
    document.getElementById("fileInput").addEventListener("change", e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = evt=>{
        try{
          const json = JSON.parse(evt.target.result);
          loadJSON(json);
        }catch(err){
          alert("JSON parse error");
        }
      };
      reader.readAsText(file);
    });

    // URL input
    document.getElementById("loadUrl").addEventListener("click", async ()=>{
      const url = document.getElementById("urlInput").value;
      if(!url) return;
      try{
        const resp = await fetch(url);
        if(!resp.ok) throw new Error("HTTP error");
        const data = await resp.json();
        loadJSON(data);
      }catch(err){
        alert("Failed to load JSON: "+err.message);
      }
    });

    // Reset button
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      camera.position.set(0,0,100);
      controls.reset();
    });

    // Fit button
    document.getElementById("fitBtn").addEventListener("click", ()=>{
      const box = new THREE.Box3().setFromObject(scene);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());
      camera.position.copy(center);
      camera.position.z += size*1.2;
      controls.target.copy(center);
      controls.update();
    });

    window.addEventListener("resize", ()=>{
      camera.aspect = container.clientWidth/container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
      labelRenderer.setSize(container.clientWidth, container.clientHeight);
    });

    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }
    animate();

  </script>
</body>
</html>
