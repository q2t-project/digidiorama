<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>digidiorama viewer — P6.7 Layer Popup</title>
  <style>
    :root { --bg: #0b1020; --fg: #e6edf3; --accent: #5aa9ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:#0e142a;border-bottom:1px solid #1d2748}
    header h1{font-size:14px;font-weight:600;margin:0;letter-spacing:.3px}
    header .spacer{flex:1}
    header select, header button{appearance:none;border:1px solid #2a3969;background:#131a33;color:var(--fg);padding:.35rem .6rem;border-radius:.4rem;cursor:pointer}
    header button:hover, header select:hover{border-color:#39529c;background:#1a2347}
    #main{display:grid;grid-template-columns:1fr 250px;overflow:hidden}
    #viewer{position:relative;overflow:hidden}
    #panel{background:#10172c;border-left:1px solid #1d2748;padding:.5rem;overflow-y:auto}
    #panel h2{font-size:13px;margin:.5rem 0}
    #panel .meta-item, #panel .error-item, #panel .node-item{font-size:12px;margin-bottom:.25rem}
    .credit{position:absolute;right:.5rem;bottom:.5rem;font-size:11px;opacity:.7}
    canvas{display:block}
    @media(max-width:600px){
      #main{grid-template-columns:1fr;}
      #panel{display:none;position:absolute;top:0;right:0;width:70%;height:100%;z-index:10}
      #panel.open{display:block;background:#0b1020}
      #fab{position:absolute;right:.75rem;bottom:.75rem;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:20px;cursor:pointer;z-index:20}
    }
    .label{color:#fff;font-size:11px;text-shadow:0 0 3px #000}
    #layerPopup{
      position:absolute;top:40px;right:10px;z-index:20;
      background:#0e142a;border:1px solid #2a3969;border-radius:.4rem;
      padding:.5rem;display:none;flex-direction:column;gap:.3rem;
    }
    #layerPopup label{font-size:13px;cursor:pointer}
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "ajv": "https://cdn.skypack.dev/ajv@8"
      }
    }
  </script>
</head>
<body>
  <div id="app">
    <header>
      <h1 data-i18n="title">digidiorama viewer — P6.7</h1>
      <div class="spacer"></div>
      <select id="fileSelect"></select>
      <select id="langSelect">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
      <button id="btnReset" data-i18n="reset">Reset</button>
      <button id="btnLayers" data-i18n="layers">Layers</button>
    </header>
    <div id="main">
      <div id="viewer"></div>
      <div id="panel">
        <h2 data-i18n="meta">Meta</h2>
        <div id="meta"></div>
        <h2 data-i18n="node">Node</h2>
        <div id="node"></div>
        <h2 data-i18n="errors">Errors</h2>
        <div id="errors"></div>
      </div>
    </div>
    <button id="fab">≡</button>
    <div id="layerPopup">
      <label><input type="checkbox" id="chkGrid" checked> Grid</label>
      <label><input type="checkbox" id="chkNodes" checked> Nodes/Edges</label>
      <label><input type="checkbox" id="chkLabels" checked> Labels</label>
    </div>
  </div>
  <div class="credit">MIT © q2t-project / Content © respective authors</div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
    import Ajv from 'ajv';

    let gridVisible=true, nodesVisible=true, labelsVisible=true;

    const container=document.getElementById('viewer');
    const scene=new THREE.Scene();scene.background=new THREE.Color(0x0b1020);
    const camera=new THREE.PerspectiveCamera(60,1,0.1,1000);camera.position.set(6,4,8);
    const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));container.appendChild(renderer.domElement);
    const labelRenderer=new CSS2DRenderer();labelRenderer.setSize(container.clientWidth,container.clientHeight);labelRenderer.domElement.style.position='absolute';labelRenderer.domElement.style.top='0';labelRenderer.domElement.style.pointerEvents='none';container.appendChild(labelRenderer.domElement);
    const controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=true;
    scene.add(new THREE.AmbientLight(0xffffff,0.6));
    const dir=new THREE.DirectionalLight(0xffffff,0.8);dir.position.set(5,10,7);scene.add(dir);
    const grid=new THREE.GridHelper(20,20,0x334477,0x223355);scene.add(grid);
    const nodeGroup=new THREE.Group();const edgeGroup=new THREE.Group();scene.add(edgeGroup,nodeGroup);
    const ro=new ResizeObserver(()=>{const {clientWidth:w,clientHeight:h}=container;renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();labelRenderer.setSize(w,h);});ro.observe(container);

    function animate(){
      controls.update();
      renderer.render(scene,camera);
      labelRenderer.render(scene,camera);
      requestAnimationFrame(animate);
    }
    animate();

    async function loadManifest(){const res=await fetch('./assets/manifest.json');return res.json();}
    async function loadDigidiorama(path){const res=await fetch(path);return res.json();}

    const schema={type:"object",properties:{meta:{type:"object"},nodes:{type:"array"},edges:{type:"array"}},required:["meta","nodes","edges"]};
    const ajv=new Ajv({allErrors:true});const validate=ajv.compile(schema);

    function runValidation(data){const valid=validate(data);if(!valid){const errs=validate.errors.map(e=>`${e.instancePath} ${e.message}`);showErrors(errs);}else{showErrors([]);}}

    const nodeById=new Map();
    function buildScene(data){
      nodeGroup.clear();edgeGroup.clear();nodeById.clear();
      const sphereGeom=new THREE.SphereGeometry(0.25,24,16);
      for(const n of data.nodes||[]){
        const mat=new THREE.MeshStandardMaterial({color:n.color||0x5aa9ff});
        const m=new THREE.Mesh(sphereGeom,mat);
        m.position.set(...n.position);
        m.userData=n;nodeGroup.add(m);nodeById.set(n.id,m);
        if(n.label){
          const div=document.createElement('div');div.className='label';div.textContent=n.label;
          const labelObj=new CSS2DObject(div);labelObj.position.set(0,0.4,0);
          m.add(labelObj);
        }
      }
      for(const e of data.edges||[]){
        const a=nodeById.get(e.source),b=nodeById.get(e.target);if(!a||!b)continue;
        const geo=new THREE.BufferGeometry().setFromPoints([a.position,b.position]);
        const mat=new THREE.LineBasicMaterial({color:e.color||0x9ec1ff});
        edgeGroup.add(new THREE.Line(geo,mat));
      }
      showMeta(data.meta,data);
    }

    function showMeta(meta,data){
      const box=document.getElementById('meta');box.innerHTML='';
      if(meta){for(const [k,v] of Object.entries(meta)){const d=document.createElement('div');d.className='meta-item';d.textContent=`${k}: ${v}`;box.appendChild(d);}}
      const counts=document.createElement('div');counts.className='meta-item';
      counts.textContent=`Counts: Nodes=${(data.nodes||[]).length}, Edges=${(data.edges||[]).length}`;
      box.appendChild(counts);
    }

    function showErrors(errs){const box=document.getElementById('errors');box.innerHTML='';(errs||[]).forEach(e=>{const d=document.createElement('div');d.className='error-item';d.textContent=e;box.appendChild(d);});}

    // i18n
    let dict={};async function loadLocale(lang){try{const res=await fetch(`./assets/i18n/${lang}.json`);dict=await res.json();applyI18n();}catch(e){console.warn("i18n load failed",e);}}
    function t(key){return dict[key]||key;}
    function applyI18n(){document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.dataset.i18n);});}

    // UI
    document.getElementById('btnReset').onclick=()=>{camera.position.set(6,4,8);controls.target.set(0,0,0);controls.update();};
    document.getElementById('fab').onclick=()=>{document.getElementById('panel').classList.toggle('open');};
    document.getElementById('langSelect').onchange=(ev)=>{loadLocale(ev.target.value)};
    document.getElementById('btnLayers').onclick=()=>{
      const popup=document.getElementById('layerPopup');
      popup.style.display=popup.style.display==='flex'?'none':'flex';
    };

    // Layer チェックボックス
    const chkGrid=document.getElementById('chkGrid');
    const chkNodes=document.getElementById('chkNodes');
    const chkLabels=document.getElementById('chkLabels');

    function updateLayers(){
      // 少なくとも Grid か Nodes のどちらかは true にする
      if(!chkGrid.checked && !chkNodes.checked){
        chkGrid.checked=true; // 強制的にGridを戻す
      }
      grid.visible=chkGrid.checked;
      nodeGroup.visible=edgeGroup.visible=chkNodes.checked;
      labelRenderer.domElement.style.display=chkLabels.checked?'block':'none';
    }

    chkGrid.onchange=updateLayers;
    chkNodes.onchange=updateLayers;
    chkLabels.onchange=updateLayers;

    // データ読み込み
    const select=document.getElementById('fileSelect');
    loadManifest().then(list=>{
      const files=Array.isArray(list)?list:list.files||[];
      files.forEach(item=>{
        const opt=document.createElement('option');
        opt.value=item.path;opt.textContent=item.title||item.path;select.appendChild(opt);
      });
      if(files[0]){
        select.value=files[0].path;
        loadDigidiorama(files[0].path).then(data=>{runValidation(data);buildScene(data);});
      }
    });
    select.onchange=()=>{loadDigidiorama(select.value).then(data=>{runValidation(data);buildScene(data);});};
    loadLocale('ja');
  </script>
</body>
</html>
