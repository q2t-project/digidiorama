<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>digidiorama viewer — P6 Layers & HUD</title>
    <style>
      :root { --bg: #0b1020; --fg: #e6edf3; --accent: #5aa9ff; }
      html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui}
      #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
      header{display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:#0e142a;border-bottom:1px solid #1d2748}
      header h1{font-size:14px;font-weight:600;margin:0;letter-spacing:.3px}
      header .spacer{flex:1}
      header select, header button{appearance:none;border:1px solid #2a3969;background:#131a33;color:var(--fg);padding:.35rem .6rem;border-radius:.4rem;cursor:pointer}
      header button:hover, header select:hover{border-color:#39529c;background:#1a2347}
      #main{display:grid;grid-template-columns:1fr 250px;overflow:hidden}
      #viewer{position:relative;overflow:hidden}
      #panel{background:#10172c;border-left:1px solid #1d2748;padding:.5rem;overflow-y:auto}
      #panel h2{font-size:13px;margin:.5rem 0}
      #panel .meta-item, #panel .error-item, #panel .node-item{font-size:12px;margin-bottom:.25rem}
      .credit{position:absolute;right:.5rem;bottom:.5rem;font-size:11px;opacity:.7}
      canvas{display:block}
      @media(max-width:600px){
        #main{grid-template-columns:1fr;}
        #panel{display:none;position:absolute;top:0;right:0;width:70%;height:100%;z-index:10}
        #panel.open{display:block;background:#0b1020}
        #fab{position:absolute;right:.75rem;bottom:.75rem;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:20px;cursor:pointer;z-index:20}
      }
      .label{color:#fff;font-size:11px;text-shadow:0 0 3px #000}
      #hud{position:absolute;top:.5rem;right:.5rem;color:#0ff;font-size:12px;background:rgba(0,0,0,0.4);padding:.3rem .5rem;border-radius:.3rem;display:none;z-index:5}
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
          "ajv": "https://cdn.skypack.dev/ajv@8"
        }
      }
    </script>
  </head>
  <body>
    <div id="app">
      <header>
        <h1 data-i18n="title">digidiorama viewer — P6</h1>
        <div class="spacer"></div>
        <select id="fileSelect"></select>
        <select id="langSelect">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
        <button id="btnReset" data-i18n="reset">Reset</button>
        <button id="btnLayers" data-i18n="layers">Layers</button>
      </header>
      <div id="main">
        <div id="viewer"></div>
        <div id="panel">
          <h2 data-i18n="meta">Meta</h2>
          <div id="meta"></div>
          <h2 data-i18n="node">Node</h2>
          <div id="node"></div>
          <h2 data-i18n="errors">Errors</h2>
          <div id="errors"></div>
        </div>
      </div>
      <button id="fab">≡</button>
    </div>
    <div id="hud">
      <div id="fps"></div>
      <div id="counts"></div>
    </div>
    <div class="credit">MIT © q2t-project / Content © respective authors</div>

    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
      import Ajv from 'ajv';
      import Stats from 'three/addons/libs/stats.module.js';

      // ---- Core setup ----
      const container=document.getElementById('viewer');
      const scene=new THREE.Scene();scene.background=new THREE.Color(0x0b1020);
      const camera=new THREE.PerspectiveCamera(60,1,0.1,1000);camera.position.set(6,4,8);
      const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));container.appendChild(renderer.domElement);
      const labelRenderer=new CSS2DRenderer();labelRenderer.setSize(container.clientWidth,container.clientHeight);labelRenderer.domElement.style.position='absolute';labelRenderer.domElement.style.top='0';labelRenderer.domElement.style.pointerEvents='none';container.appendChild(labelRenderer.domElement);
      const controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=true;
      scene.add(new THREE.AmbientLight(0xffffff,0.6));const dir=new THREE.DirectionalLight(0xffffff,0.8);dir.position.set(5,10,7);scene.add(dir);
      const grid=new THREE.GridHelper(20,20,0x334477,0x223355);scene.add(grid);
      const nodeGroup=new THREE.Group();const edgeGroup=new THREE.Group();scene.add(edgeGroup,nodeGroup);
      const ro=new ResizeObserver(()=>{const {clientWidth:w,clientHeight:h}=container;renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();labelRenderer.setSize(w,h);});ro.observe(container);

      // HUD
      const hud=document.getElementById('hud');const fpsBox=document.getElementById('fps');const countBox=document.getElementById('counts');
      const stats=new Stats();stats.showPanel(0); // FPS
      stats.dom.style.position='absolute';stats.dom.style.top='0';stats.dom.style.left='0';stats.dom.style.display='none';
      container.appendChild(stats.dom);

      function animate(){
        controls.update();
        renderer.render(scene,camera);
        labelRenderer.render(scene,camera);
        if(hudVisible){stats.update();}
        requestAnimationFrame(animate);
      }
      animate();

      // ---- DataAccess ----
      async function loadManifest(){const res=await fetch('./assets/manifest.json');return res.json();}
      async function loadDigidiorama(path){const res=await fetch(path);return res.json();}

      // ---- Validation ----
      const schema={type:\"object\",properties:{meta:{type:\"object\"},nodes:{type:\"array\"},edges:{type:\"array\"}},required:[\"meta\",\"nodes\",\"edges\"]};
      const ajv=new Ajv({allErrors:true});
      const validate=ajv.compile(schema);

      function runValidation(data){
        const valid=validate(data);
        if(!valid){
          const errs=validate.errors.map(e=>`${e.instancePath} ${e.message}`);
          showErrors(errs);
        } else { showErrors([]); }
      }

      // ---- Build scene ----
      const nodeById=new Map();
      function buildScene(data){
        nodeGroup.clear();edgeGroup.clear();nodeById.clear();
        const sphereGeom=new THREE.SphereGeometry(0.25,24,16);
        for(const n of data.nodes||[]){
          const mat=new THREE.MeshStandardMaterial({color:n.color||0x5aa9ff});
          const m=new THREE.Mesh(sphereGeom,mat);
          m.position.set(...n.position);
          m.userData=n;nodeGroup.add(m);nodeById.set(n.id,m);
          if(n.label && n.label.length<=10){
            const div=document.createElement('div');div.className='label';div.textContent=n.label;
            const labelObj=new CSS2DObject(div);labelObj.position.set(0,0.4,0);m.add(labelObj);
          }
        }
        const lineMat=new THREE.LineBasicMaterial({color:0x9ec1ff});
        for(const e of data.edges||[]){const a=nodeById.get(e.source),b=nodeById.get(e.target);if(!a||!b)continue;const geo=new THREE.BufferGeometry().setFromPoints([a.position,b.position]);edgeGroup.add(new THREE.Line(geo,lineMat));}
        showMeta(data.meta);
        updateCounts(data);
      }

      function updateCounts(data){
        countBox.textContent=`Nodes: ${(data.nodes||[]).length}, Edges: ${(data.edges||[]).length}`;
      }

      // ---- Panels ----
      function showMeta(meta){const box=document.getElementById('meta');box.innerHTML='';if(!meta)return;for(const [k,v] of Object.entries(meta)){const d=document.createElement('div');d.className='meta-item';d.textContent=`${k}: ${v}`;box.appendChild(d);}}
      function showNode(node){const box=document.getElementById('node');box.innerHTML='';if(!node)return;for(const [k,v] of Object.entries(node)){if(['id','label','description','tags','position','color','size','links'].includes(k)){const d=document.createElement('div');d.className='node-item';if(k==='links'&&Array.isArray(v)){v.forEach(l=>{const a=document.createElement('a');a.href=l;a.textContent=l;a.target='_blank';box.appendChild(a);box.appendChild(document.createElement('br'));});} else {d.textContent=`${k}: ${Array.isArray(v)?v.join(','):v}`;box.appendChild(d);}}}}
      function showErrors(errs){const box=document.getElementById('errors');box.innerHTML='';(errs||[]).forEach(e=>{const d=document.createElement('div');d.className='error-item';d.textContent=e;box.appendChild(d);});}

      // ---- i18n ----
      let dict={};async function loadLocale(lang){try{const res=await fetch(`./assets/i18n/${lang}.json`);dict=await res.json();applyI18n();}catch{console.warn(\"i18n load failed\")}}
      function t(key){return dict[key]||key;}function applyI18n(){document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.dataset.i18n);});}

      // ---- Interaction ----
      const raycaster=new THREE.Raycaster();const mouse=new THREE.Vector2();let selected=null;
      function onClick(ev){const rect=renderer.domElement.getBoundingClientRect();mouse.x=((ev.clientX-rect.left)/rect.width)*2-1;mouse.y=-((ev.clientY-rect.top)/rect.height)*2+1;raycaster.setFromCamera(mouse,camera);const hits=raycaster.intersectObjects(nodeGroup.children,false);if(hits.length){if(selected){selected.scale.set(1,1,1);selected.material.emissive?.setHex(0x000000);}selected=hits[0].object;selected.scale.set(1.4,1.4,1.4);if(selected.material.emissive){selected.material.emissive.setHex(0x224466);} else {selected.material.emissive=new THREE.Color(0x224466);}showNode(selected.userData);}}
      renderer.domElement.addEventListener('click',onClick);

      // ---- UI bindings ----
      document.getElementById('btnReset').onclick=()=>{camera.position.set(6,4,8);controls.target.set(0,0,0);controls.update();};
      document.getElementById('fab').onclick=()=>{document.getElementById('panel').classList.toggle('open');};
      document.getElementById('langSelect').onchange=(ev)=>{loadLocale(ev.target.value)};

      let gridVisible=true,nodesVisible=true,labelsVisible=true,hudVisible=false;
      document.getElementById('btnLayers').onclick=()=>{
        gridVisible=!gridVisible;grid.visible=gridVisible;
        nodesVisible=!nodesVisible;nodeGroup.visible=nodesVisible;edgeGroup.visible=nodesVisible;
        labelsVisible=!labelsVisible;labelRenderer.domElement.style.display=labelsVisible?'block':'none';
        hudVisible=!hudVisible;hud.style.display=hudVisible?'block':'none';stats.dom.style.display=hudVisible?'block':'none';
      };

      const select=document.getElementById('fileSelect');
      loadManifest().then(list=>{const files=Array.isArray(list)?list:list.files||[];files.forEach(item=>{const opt=document.createElement('option');opt.value=item.path;opt.textContent=item.title||item.path;select.appendChild(opt);});if(files[0]){select.value=files[0].path;loadDigidiorama(files[0].path).then(data=>{runValidation(data);buildScene(data);});}});
      select.onchange=()=>{loadDigidiorama(select.value).then(data=>{runValidation(data);buildScene(data);});};

      loadLocale('ja');
    </script>
  </body>
</html>
