<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>digidiorama viewer — P2</title>
  <style>
    body { margin:0; display:flex; background:#111; color:#eee; font-family:sans-serif; }
    #viewer { flex:1; }
    #side { width:280px; background:#161a20; padding:10px; overflow:auto; }
    button { margin:2px; padding:4px 10px; }
  </style>
</head>
<body>
  <div id="viewer"></div>
  <div id="side">
    <button id="loadSample">Sample Diagram</button>
    <button id="langBtn">日本語</button>
    <button id="resetBtn">Reset</button>
    <button id="layersBtn">layers</button>
    <h3>メタ情報</h3><pre id="meta"></pre>
    <h3>node</h3><pre id="nodeInfo"></pre>
    <h3>エラー</h3><pre id="errors"></pre>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth-280, window.innerHeight);
    document.getElementById("viewer").appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0d10);

    const camera = new THREE.PerspectiveCamera(60,(window.innerWidth-280)/window.innerHeight,0.1,1000);
    camera.position.set(3,3,5);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.GridHelper(10,10,0x444444,0x222222));

    const light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(5,10,7);
    scene.add(light, new THREE.AmbientLight(0x888888));

    // ===== Label Plane generator =====
    function makeLabelPlane(text, options={}) {
      const fontSize = options.fontSize || 28;
      const color = options.color || "white";
      const offset = options.offset || [0,0.15,0];

      const canvas = document.createElement("canvas");
      canvas.width = 256;
      canvas.height = 64;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = color;
      ctx.font = `${fontSize}px Arial`;
      ctx.textBaseline = "middle";
      ctx.fillText(text, 10, canvas.height/2);

      const texture = new THREE.CanvasTexture(canvas);
      const mat = new THREE.MeshBasicMaterial({ map:texture, transparent:true, side:THREE.DoubleSide });
      const geom = new THREE.PlaneGeometry(1.5,0.6);
      const mesh = new THREE.Mesh(geom, mat);
      mesh.position.set(...offset);
      return mesh;
    }

    // ===== Sample JSON =====
    const sample = {
      "title":"Sample Diagram",
      "author":"q2t-project",
      "created":"2025-09-16",
      "nodes":[
        { "id":"a", "label":"Alpha", "position":[0,0,0],
          "labelAttr":{"fontSize":32,"color":"#ffcc00","offset":[0,0.2,0]} },
        { "id":"b", "label":"Beta", "position":[1.2,0.4,-0.6],
          "labelAttr":{"fontSize":28,"color":"#00ccff","offset":[0,0.2,0]} }
      ],
      "edges":[ { "source":"a","target":"b" } ]
    };

    function buildScene(data){
      while(scene.children.length>0){ scene.remove(scene.children[0]); }
      scene.add(new THREE.GridHelper(10,10,0x444444,0x222222), light, camera);

      document.getElementById("meta").textContent =
        `title: ${data.title}\nauthor: ${data.author}\ncreated: ${data.created}\nCounts: Nodes=${data.nodes.length}, Edges=${data.edges.length}`;

      const nodeMap={};
      data.nodes.forEach(n=>{
        // ノードは点（目立たない小さな半透明球）
        const g=new THREE.SphereGeometry(0.05,8,8);
        const m=new THREE.MeshBasicMaterial({color:0xaaaaaa,transparent:true,opacity:0.3});
        const mesh=new THREE.Mesh(g,m);
        mesh.position.set(...n.position);
        scene.add(mesh);
        nodeMap[n.id]=mesh;

        if(n.label){
          const label=makeLabelPlane(n.label,n.labelAttr||{});
          mesh.add(label);
        }
      });

      data.edges.forEach(e=>{
        const s=nodeMap[e.source], t=nodeMap[e.target];
        if(s&&t){
          const pts=[s.position,t.position];
          const g=new THREE.BufferGeometry().setFromPoints(pts);
          const l=new THREE.Line(g,new THREE.LineBasicMaterial({color:0xffffff}));
          scene.add(l);
        }
      });
    }

    buildScene(sample);

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene,camera);
    }
    animate();

    document.getElementById("loadSample").onclick=()=>buildScene(sample);
  </script>
</body>
</html>
