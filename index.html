<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>digidiorama viewer</title>

  <!-- favicon（404対策・プロジェクトの assets/ に配置想定） -->
  <link rel="icon" href="./assets/favicon.ico" />

  <style>
    :root{
      --bg:#0e1522;
      --panel:#0f1a2b;
      --text:#e8eefc;
      --muted:#a8b3c9;
      --accent:#6aa9ff;
      --ok:#41d1a7;
      --warn:#ffb454;
      --err:#ff6464;
      --btn:#16233b;
      --btn-hover:#1c2b4d;
      --badge:#23365e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.6 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo","Helvetica Neue",Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    .toolbar{
      position:fixed;inset:0 0 auto 0;height:56px;display:flex;gap:10px;
      align-items:center;padding:8px 12px;background:#0e1522ee;backdrop-filter:saturate(150%) blur(4px);z-index:10;
      border-bottom:1px solid #0f2544;
    }
    .spacer{flex:1}
    .btn{
      display:inline-flex;align-items:center;gap:.5rem;height:40px;padding:0 14px;border-radius:10px;border:1px solid #223456;
      background:var(--btn);color:var(--text);cursor:pointer;user-select:none;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn.active{outline:2px solid var(--accent)}
    .select{height:40px;border-radius:10px;border:1px solid #223456;background:var(--btn);color:var(--text);padding:0 10px}
    #stage{position:fixed;inset:56px 0 24px 0}
    #hud{position:fixed;inset:auto 0 0 0;height:24px;display:flex;align-items:center;gap:12px;padding:2px 10px;color:var(--muted);background:#0e1522cc;border-top:1px solid #0f2544;font-size:12px}
    .menu{
      position:relative
    }
    .menu > .panel{
      position:absolute;right:0;top:48px;background:var(--panel);border:1px solid #223456;border-radius:12px;min-width:220px;
      box-shadow:0 10px 30px #0006;padding:10px;display:none;z-index:20
    }
    .menu.open > .panel{display:block}
    .row{display:flex;align-items:center;justify-content:space-between;padding:4px 0}
    .row label{color:var(--muted)}
    .switch{width:44px;height:24px;border-radius:999px;background:#1c2b4d;position:relative;cursor:pointer;border:1px solid #223456}
    .switch input{appearance:none;width:0;height:0;opacity:0;position:absolute}
    .switch i{
      position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:999px;background:#8898b3;transition:transform .18s ease, background .18s ease
    }
    .switch input:checked + i{transform:translateX(20px);background:#9fe870}
    .meta{padding:6px 10px;border-radius:10px;background:var(--badge);color:#cfe1ff;font-size:12px}
    .badge{padding:2px 8px;border-radius:999px;background:#1e2c49; color:#cfe1ff;font-size:12px}
    .vis-chip{display:inline-flex;gap:6px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    canvas{display:block}
  </style>
</head>
<body>
  <div class="toolbar">
    <select id="fileSelect" class="select" title="デモデータ">
      <option value="">Loading…</option>
    </select>
  <svg xmlns="http://www.w3.org/2000/svg" width="46.892pt" height="9.166pt" viewBox="0 0 46.892 9.166">
  <path d="M4.641,1.050 L4.641,0.074 L0.714,0.074 Q0.568,0.074 0.463,0.179 Q0.358,0.284 0.358,0.441 L0.358,0.683 Q0.358,0.829 0.463,0.940 Q0.568,1.050 0.714,1.050 L4.641,1.050 Z M0.525,8.789 Q0.525,8.935 0.630,9.045 Q0.735,9.156 0.883,9.156 L2.940,9.156 Q3.307,9.156 3.570,8.894 L3.780,8.684 Q4.043,8.421 4.043,8.054 L4.043,4.379 Q4.043,4.210 4.143,4.111 Q4.243,4.011 4.410,4.011 L6.500,4.011 Q6.658,4.011 6.768,3.901 Q6.878,3.790 6.878,3.644 L6.878,3.401 Q6.878,3.244 6.768,3.139 Q6.658,3.034 6.500,3.034 L0.358,3.034 Q0.210,3.034 0.105,3.139 Q0.000,3.244 0.000,3.401 L0.000,3.644 Q0.000,3.790 0.105,3.901 Q0.210,4.011 0.358,4.011 L2.709,4.011 Q2.878,4.011 2.976,4.111 Q3.076,4.210 3.076,4.379 L3.076,7.801 Q3.076,7.959 2.966,8.069 Q2.856,8.179 2.699,8.179 L0.883,8.179 Q0.735,8.179 0.630,8.284 Q0.525,8.389 0.525,8.546 L0.525,8.789 Z M6.290,1.365 Q6.448,1.365 6.541,1.271 Q6.636,1.176 6.636,1.019 L6.636,0.399 Q6.636,0.241 6.541,0.148 Q6.448,0.053 6.290,0.053 Q5.954,0.053 5.954,0.399 L5.954,1.019 Q5.954,1.365 6.290,1.365 Z M5.271,1.365 Q5.608,1.365 5.608,1.019 L5.608,0.399 Q5.608,0.053 5.271,0.053 Q5.114,0.053 5.019,0.148 Q4.925,0.241 4.925,0.399 L4.925,1.019 Q4.925,1.176 5.019,1.271 Q5.114,1.365 5.271,1.365 Z M14.006,1.365 Q14.164,1.365 14.259,1.271 Q14.354,1.176 14.354,1.019 L14.354,0.399 Q14.354,0.241 14.259,0.148 Q14.164,0.053 14.006,0.053 Q13.672,0.053 13.672,0.399 L13.672,1.019 Q13.672,1.365 14.006,1.365 Z M12.989,1.365 Q13.324,1.365 13.324,1.019 L13.324,0.399 Q13.324,0.053 12.989,0.053 Q12.832,0.053 12.736,0.148 Q12.641,0.241 12.641,0.399 L12.641,1.019 Q12.641,1.176 12.736,1.271 Q12.832,1.365 12.989,1.365 Z M10.111,2.016 Q10.364,2.289 10.720,2.289 L11.644,2.289 Q11.813,2.289 11.911,2.189 Q12.011,2.089 12.011,1.921 L12.011,1.690 Q12.011,1.523 11.911,1.422 Q11.813,1.322 11.644,1.322 L11.152,1.322 Q10.794,1.322 10.541,1.050 L9.859,0.272 Q9.608,0.000 9.250,0.000 L8.704,0.000 Q8.494,0.000 8.494,0.115 Q8.494,0.158 8.579,0.272 L10.111,2.016 Z M9.419,4.630 Q9.670,4.904 10.038,4.904 L10.961,4.904 Q11.130,4.904 11.229,4.804 Q11.329,4.704 11.329,4.536 L11.329,4.305 Q11.329,4.136 11.229,4.038 Q11.130,3.938 10.961,3.938 L10.448,3.938 Q10.080,3.938 9.828,3.664 L9.040,2.783 Q8.789,2.509 8.422,2.509 L7.875,2.509 Q7.675,2.509 7.675,2.614 Q7.675,2.699 7.759,2.783 L9.419,4.630 Z M8.231,9.156 L11.371,9.156 Q11.791,9.156 12.064,8.946 L12.400,8.672 Q12.694,8.441 12.832,8.116 L14.238,4.064 Q14.280,3.947 14.280,3.926 Q14.280,3.706 13.996,3.706 L13.713,3.706 Q13.366,3.706 13.209,4.052 L11.865,7.832 Q11.739,8.190 11.362,8.179 L8.231,8.179 Q8.085,8.179 7.974,8.284 Q7.864,8.389 7.864,8.546 L7.864,8.789 Q7.864,8.935 7.974,9.045 Q8.085,9.156 8.231,9.156 Z M23.540,1.365 Q23.698,1.365 23.793,1.271 Q23.888,1.176 23.888,1.019 L23.888,0.399 Q23.888,0.241 23.793,0.148 Q23.698,0.053 23.540,0.053 Q23.206,0.053 23.206,0.399 L23.206,1.019 Q23.206,1.365 23.540,1.365 Z M22.523,1.365 Q22.858,1.365 22.858,1.019 L22.858,0.399 Q22.858,0.053 22.523,0.053 Q22.366,0.053 22.270,0.148 Q22.175,0.241 22.175,0.399 L22.175,1.019 Q22.175,1.176 22.270,1.271 Q22.366,1.365 22.523,1.365 Z M19.645,2.016 Q19.898,2.289 20.254,2.289 L21.178,2.289 Q21.347,2.289 21.445,2.189 Q21.545,2.089 21.545,1.921 L21.545,1.690 Q21.545,1.523 21.445,1.422 Q21.347,1.322 21.178,1.322 L20.686,1.322 Q20.328,1.322 20.075,1.050 L19.393,0.272 Q19.142,0.000 18.784,0.000 L18.238,0.000 Q18.028,0.000 18.028,0.115 Q18.028,0.158 18.113,0.272 L19.645,2.016 Z M18.953,4.630 Q19.204,4.904 19.572,4.904 L20.495,4.904 Q20.664,4.904 20.763,4.804 Q20.863,4.704 20.863,4.536 L20.863,4.305 Q20.863,4.136 20.763,4.038 Q20.664,3.938 20.495,3.938 L19.982,3.938 Q19.614,3.938 19.362,3.664 L18.574,2.783 Q18.323,2.509 17.956,2.509 L17.409,2.509 Q17.209,2.509 17.209,2.614 Q17.209,2.699 17.293,2.783 L18.953,4.630 Z M17.765,9.156 L20.905,9.156 Q21.325,9.156 21.598,8.946 L21.934,8.672 Q22.228,8.441 22.366,8.116 L23.772,4.064 Q23.814,3.947 23.814,3.926 Q23.814,3.706 23.530,3.706 L23.247,3.706 Q22.900,3.706 22.743,4.052 L21.399,7.832 Q21.273,8.190 20.896,8.179 L17.765,8.179 Q17.619,8.179 17.508,8.284 Q17.398,8.389 17.398,8.546 L17.398,8.789 Q17.398,8.935 17.508,9.045 Q17.619,9.156 17.765,9.156 Z M27.404,2.604 L26.113,7.832 Q26.082,7.980 25.946,8.085 Q25.810,8.190 25.652,8.190 L25.337,8.190 Q25.189,8.190 25.084,8.295 Q24.979,8.400 24.979,8.558 L24.979,8.789 Q24.979,8.935 25.084,9.045 Q25.189,9.156 25.337,9.156 L26.428,9.156 Q26.743,9.156 26.879,8.799 L28.371,2.699 Q28.444,2.404 28.759,2.404 L29.284,2.404 Q29.432,2.404 29.542,2.509 Q29.652,2.614 29.652,2.761 L29.652,7.823 Q29.652,7.980 29.542,8.085 Q29.432,8.190 29.284,8.190 L28.361,8.190 Q28.203,8.190 28.092,8.295 Q27.982,8.400 27.982,8.558 L27.982,8.789 Q27.982,8.935 28.097,9.045 Q28.213,9.156 28.361,9.156 L29.494,9.156 Q29.673,9.156 29.888,9.056 Q30.103,8.956 30.239,8.777 L30.356,8.663 Q30.640,8.379 30.618,8.033 L30.618,2.761 Q30.618,2.614 30.723,2.509 Q30.828,2.404 31.007,2.404 L31.206,2.404 Q31.342,2.404 31.452,2.294 Q31.563,2.184 31.563,2.036 L31.563,1.795 Q31.563,1.637 31.452,1.523 Q31.342,1.406 31.206,1.406 L31.007,1.406 Q30.618,1.406 30.618,1.050 L30.618,0.368 Q30.618,0.220 30.507,0.115 Q30.397,0.010 30.251,0.010 L30.019,0.010 Q29.872,0.010 29.762,0.115 Q29.652,0.220 29.652,0.368 L29.652,1.050 Q29.652,1.208 29.542,1.308 Q29.432,1.406 29.284,1.406 L25.337,1.406 Q25.189,1.406 25.084,1.523 Q24.979,1.637 24.979,1.795 L24.979,2.036 Q24.979,2.184 25.084,2.294 Q25.189,2.404 25.337,2.404 L27.142,2.404 Q27.404,2.404 27.404,2.604 Z M33.841,8.789 Q33.841,8.935 33.946,9.045 Q34.051,9.156 34.198,9.156 L35.647,9.156 Q35.816,9.156 35.983,9.114 Q36.151,9.071 36.330,8.956 L36.592,8.789 Q36.907,8.579 37.065,8.252 L39.102,3.854 Q39.176,3.696 39.217,3.508 Q39.260,3.317 39.260,3.014 Q39.260,2.845 39.165,2.746 Q39.071,2.646 38.892,2.646 L33.034,2.646 Q32.865,2.646 32.765,2.741 Q32.666,2.835 32.666,3.014 L32.666,3.255 Q32.666,3.422 32.760,3.522 Q32.855,3.623 33.034,3.623 L37.768,3.623 Q38.010,3.623 38.010,3.801 Q38.010,3.833 38.005,3.870 Q38.000,3.906 37.978,3.959 L36.162,7.844 Q36.079,8.021 35.941,8.100 Q35.805,8.179 35.637,8.179 L34.198,8.179 Q34.051,8.179 33.946,8.284 Q33.841,8.389 33.841,8.546 L33.841,8.789 Z M33.358,1.050 L38.577,1.050 Q38.735,1.050 38.845,0.940 Q38.955,0.829 38.955,0.683 L38.955,0.441 Q38.955,0.284 38.845,0.179 Q38.735,0.074 38.577,0.074 L33.358,0.074 Q33.211,0.074 33.106,0.179 Q33.001,0.284 33.001,0.441 L33.001,0.683 Q33.001,0.829 33.106,0.940 Q33.211,1.050 33.358,1.050 Z M44.384,8.820 Q44.594,9.166 44.940,9.166 L45.601,9.166 Q45.780,9.166 45.874,9.061 Q45.969,8.956 45.969,8.789 L45.969,8.536 Q45.969,8.159 45.601,8.159 L45.422,8.159 Q45.129,8.159 44.919,7.823 L44.425,6.983 Q44.320,6.814 44.320,6.604 Q44.320,6.426 44.415,6.257 L46.715,2.258 Q46.820,2.079 46.856,1.900 Q46.892,1.721 46.892,1.544 L46.892,0.546 Q46.892,0.167 46.525,0.167 L40.604,0.167 Q40.425,0.167 40.330,0.272 Q40.236,0.377 40.236,0.546 L40.236,0.809 Q40.236,1.186 40.604,1.186 L45.591,1.186 Q45.906,1.186 45.906,1.427 Q45.906,1.628 45.727,1.964 L43.785,5.355 Q43.680,5.522 43.618,5.522 Q43.544,5.522 43.449,5.365 L42.167,3.244 Q41.947,2.888 41.611,2.888 L41.181,2.888 Q40.993,2.888 40.897,2.997 Q40.802,3.107 40.802,3.276 L40.802,3.559 Q40.802,3.906 41.160,3.906 Q41.432,3.906 41.632,4.221 L44.384,8.820 Z" fill="#000000"/>
  </svg>
    <button id="btnLang" class="btn" title="言語切替">日本語</button>
    <button id="btnReset" class="btn" title="初期ビューへ戻す">Reset</button>
    <button id="btnFit" class="btn" title="ノードにフィット">Fit</button>

    <div class="menu" id="layersMenu">
      <button id="btnLayers" class="btn">Layers ▾</button>
      <div class="panel">
        <div class="row"><label>Nodes</label>
          <span class="vis-chip">
            <span id="count-nodes" class="badge">0</span>
            <span class="switch"><input id="toggle-nodes" type="checkbox" checked><i></i></span>
          </span>
        </div>
        <div class="row"><label>Edges</label>
          <span class="vis-chip">
            <span id="count-edges" class="badge">0</span>
            <span class="switch"><input id="toggle-edges" type="checkbox" checked><i></i></span>
          </span>
        </div>
        <div class="row"><label>Labels</label>
          <span class="switch"><input id="toggle-labels" type="checkbox" checked><i></i></span>
        </div>
        <div class="row"><label>Aux</label>
          <span class="switch"><input id="toggle-aux" type="checkbox" checked><i></i></span>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <span class="meta" id="metaTitle">—</span>
  </div>

  <div id="stage"></div>

  <div id="hud">
    <span>MIT © q2t-project</span>
    <span id="version" class="mono"></span>
    <span id="counts" class="mono"></span>
    <span id="msg" class="mono"></span>
  </div>

  <!-- Three.js + controls はローカルの scripts/ 配下から相対import -->
  <script type="module">
    /******************************************************************
     * Imports
     ******************************************************************/
    import * as THREE from './scripts/three.module.js';
    import { OrbitControls } from './scripts/OrbitControls.js';
    // Ajv ESM(2020 bundle)。存在しない場合は try/catch でスキップ可能に
    let Ajv = null;
    try {
      const m = await import('./scripts/2020.bundle.mjs').catch(()=>import('./scripts/2020bundle.mjs')).catch(()=>null);
      Ajv = m?.default ?? m?.Ajv ?? null;
    } catch(_){ Ajv = null }

    /******************************************************************
     * Globals
     ******************************************************************/
    const NS = 'ddv:v2:';                   // localStorage 名前空間
    const VERSION = 'v2.0.0';               // 表示用バージョン
    document.getElementById('version').textContent = ` ${VERSION}`;

    // Three.js essentials
    const container = document.getElementById('stage');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0e1522);
    const camera = new THREE.PerspectiveCamera(60, 16/9, 0.1, 1e7);
    const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // groups
    const root = new THREE.Group();
    const nodeGroup = new THREE.Group();
    const edgeGroup = new THREE.Group();
    const labelGroup = new THREE.Group();
    const auxiliaryGroup = new THREE.Group();
    root.add(nodeGroup, edgeGroup, labelGroup, auxiliaryGroup);
    scene.add(root);

    // lights
    {
      const a = new THREE.AmbientLight(0xffffff, .45);
      const d = new THREE.DirectionalLight(0xffffff, .6);
      d.position.set(1,2,3);
      scene.add(a, d);
    }

    // viewport / resize
    function resize(){
      const w = container.clientWidth, h = container.clientHeight;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h, false);
    }
    new ResizeObserver(resize).observe(container);

    // HUD
    const $msg = document.getElementById('msg');
    const $metaTitle = document.getElementById('metaTitle');
    const $counts = document.getElementById('counts');
    const $cn = (id)=>document.getElementById(id);

    // menu toggle
    const layersMenu = document.getElementById('layersMenu');
    document.getElementById('btnLayers').addEventListener('click', ()=>{
      layersMenu.classList.toggle('open');
    });
    window.addEventListener('click', (e)=>{
      if (!layersMenu.contains(e.target) && layersMenu.classList.contains('open')){
        layersMenu.classList.remove('open');
      }
    });

    /******************************************************************
     * Home pose / layer defaults
     ******************************************************************/
    let home = {
      pos: new THREE.Vector3(300, 300, 300),
      target: new THREE.Vector3(0,0,0),
      up: new THREE.Vector3(0,0,1),
      fov: 60
    };
    const layersDefault = { nodes:true, edges:true, labels:true, aux:true };

    function rememberHomeFromCurrentView(){
      home.pos.copy(camera.position);
      home.target.copy(controls.target);
      home.up.copy(camera.up);
      home.fov = camera.fov;
    }
    function resetView(){
      camera.fov = home.fov;
      camera.position.copy(home.pos);
      camera.up.copy(home.up);
      camera.updateProjectionMatrix();
      controls.target.copy(home.target);
      controls.update();

      // レイヤーを既定に
      const pairs = [
        ['toggle-nodes',  nodeGroup,      layersDefault.nodes],
        ['toggle-edges',  edgeGroup,      layersDefault.edges],
        ['toggle-labels', labelGroup,     layersDefault.labels],
        ['toggle-aux',    auxiliaryGroup, layersDefault.aux],
      ];
      for (const [id, group, def] of pairs){
        const el = $cn(id); if (el) el.checked = def;
        group.visible = def;
      }
      saveLayers();
    }

    /******************************************************************
     * Fit camera
     ******************************************************************/
    function fitCameraToScene(padding=1.25){
      const box = new THREE.Box3().setFromObject(root);
      if (box.isEmpty()){
        camera.position.set(300,300,300);
        controls.target.set(0,0,0);
        controls.update();
        return;
      }
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const maxDim = Math.max(size.x,size.y,size.z) || 1;
      const fov = camera.fov * Math.PI/180;
      let dist = Math.abs(maxDim/2 / Math.tan(fov/2));
      dist *= padding;
      camera.position.set(center.x + dist, center.y + dist, center.z + dist);
      controls.target.copy(center);
      controls.update();
    }
    function fitCameraToNodes(nodes, padding=1.25){
      const box = new THREE.Box3();
      if (Array.isArray(nodes) && nodes.length){
        for (const n of nodes){
          if (n?.position && n.position.length===3){
            box.expandByPoint(new THREE.Vector3(...n.position));
          }
        }
      }
      if (box.isEmpty()){
        fitCameraToScene(padding);
        return;
      }
      const size = box.getSize(new THREE.Vector3());
      const center = box.getCenter(new THREE.Vector3());
      const maxDim = Math.max(size.x,size.y,size.z) || 1;
      const fov = camera.fov * Math.PI/180;
      let dist = Math.abs(maxDim/2 / Math.tan(fov/2));
      dist *= padding;
      camera.position.set(center.x + dist, center.y + dist, center.z + dist);
      controls.target.copy(center);
      controls.update();
    }

    /******************************************************************
     * Data loading (manifest + model)
     ******************************************************************/
    async function loadManifest(){
      // ルート or assets に置かれた manifest を読む
      const res = await fetch('./assets/manifest.json').catch(()=>fetch('./manifest.json'));
      if (!res.ok) throw new Error('manifest not found');
      return res.json();
    }
    async function loadDigidiorama(path){
      const bust = `?v=${Date.now()}`;
      const res = await fetch(path + (path.includes('?')?'&':'?') + 'v=' + Date.now());
      if (!res.ok) throw new Error(`load error: ${path}`);
      return res.json();
    }

    /******************************************************************
     * AJV validation (optional)
     ******************************************************************/
    let validateModel = null, validateManifest = null;
    async function loadSchemas(){
      try{
        if (!Ajv) throw new Error('Ajv not available');
        const [modelSchema, manifestSchema] = await Promise.all([
          fetch('./digidiorama.schema.json').then(r=> r.ok ? r.json() : Promise.reject(new Error('model schema not found'))),
          fetch('./manifest.schema.json').then(r=> r.ok ? r.json() : Promise.reject(new Error('manifest schema not found')))
        ]);
        const ajv = new Ajv({ strict:false, allErrors:true, allowUnionTypes:true });
        validateModel = ajv.compile(modelSchema);
        validateManifest = ajv.compile(manifestSchema);
      }catch(err){
        console.warn('Schema load failed, fallback to minimal schema', err);
        const ajv = Ajv ? new Ajv({strict:false}) : null;
        const fallback = { type:'object', properties:{ meta:{type:'object'}, nodes:{type:'array'}, edges:{type:'array'}, auxiliary:{type:'array'} } };
        validateModel = ajv ? ajv.compile(fallback) : (data)=>true;
        validateManifest = ajv ? ajv.compile({type:'object'}) : (data)=>true;
      }
    }

    function runValidation(data){
      const msgs = [];
      if (validateModel){
        const ok = validateModel(data);
        if (!ok) msgs.push(...validateModel.errors.map(e=> `${e.instancePath || '/'} ${e.message}`));
      }
      // 追加の整合チェック（ID重複など軽く）
      msgs.push(...extraChecks(data));
      showErrors(msgs);
    }
    function extraChecks(data){
      const msgs = [];
      const ids = new Set();
      if (Array.isArray(data?.nodes)){
        for (const n of data.nodes){
          if (!n || typeof n.id !== 'string') continue;
          if (ids.has(n.id)) msgs.push(`Duplicate node id: ${n.id}`);
          ids.add(n.id);
        }
      }
      if (Array.isArray(data?.edges)){
        const idset = new Set((data.nodes||[]).map(n=>n.id));
        for (const e of data.edges){
          if (e && typeof e.source==='string' && !idset.has(e.source)) msgs.push(`Edge source not found: ${e.source}`);
          if (e && typeof e.target==='string' && !idset.has(e.target)) msgs.push(`Edge target not found: ${e.target}`);
        }
      }
      return msgs;
    }
    function showErrors(errs){
      if (!errs || !errs.length){ $msg.textContent=''; return; }
      $msg.textContent = '⚠ ' + errs.slice(0,3).join(' | ') + (errs.length>3 ? ` …(+${errs.length-3})`:'');
    }

    /******************************************************************
     * Scene building helpers
     ******************************************************************/
    const NODE_GEOM = new THREE.SphereGeometry(2, 10, 10);
    const NODE_MAT  = new THREE.MeshStandardMaterial({color:0x88aaff, roughness:.35, metalness:.1});

    function makeLabelSprite(text, attr={}){
      const fontSize = Math.max(12, attr.fontSize||24);
      const color = attr.color || '#ffffff';
      const bg = attr.background || null;

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const padding = Math.round(fontSize*0.3);
      ctx.font = `bold ${fontSize}px "Segoe UI", "Noto Sans JP", sans-serif`;
      const metrics = ctx.measureText(text);
      const w = Math.ceil(metrics.width)+padding*2, h = fontSize+padding*2;
      canvas.width = w; canvas.height = h;

      // paint
      if (bg){
        ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
      }
      ctx.font = `bold ${fontSize}px "Segoe UI", "Noto Sans JP", sans-serif`;
      ctx.fillStyle = color;
      ctx.textBaseline = 'middle';
      ctx.fillText(text, padding, h/2);

      const tex = new THREE.CanvasTexture(canvas);
      tex.minFilter = THREE.LinearFilter;
      const mat = new THREE.SpriteMaterial({map:tex, transparent: !!bg});
      const spr = new THREE.Sprite(mat);
      // 尺度調整（1px=0.5Unit程度）
      spr.scale.set(w*0.5, h*0.5, 1);
      return spr;
    }

    function clearGroup(grp){
      for (let i=grp.children.length-1; i>=0; i--){
        const o = grp.children[i];
        if (o.geometry) o.geometry.dispose();
        if (o.material){
          if (Array.isArray(o.material)) o.material.forEach(m=>m.dispose()); else o.material.dispose();
        }
        if (o.texture) o.texture.dispose?.();
        grp.remove(o);
      }
    }

    function buildScene(data){
      clearGroup(nodeGroup); clearGroup(edgeGroup); clearGroup(labelGroup); clearGroup(auxiliaryGroup);

      const mapPos = new Map();
      if (Array.isArray(data?.nodes)){
        for (const n of data.nodes){
          const p = Array.isArray(n.position) && n.position.length===3 ? n.position : [0,0,0];
          mapPos.set(n.id, new THREE.Vector3(p[0], p[1], p[2]));
          const mesh = new THREE.Mesh(NODE_GEOM, NODE_MAT.clone());
          mesh.position.set(p[0], p[1], p[2]);
          nodeGroup.add(mesh);

          // label
          const label = (n.label ?? n.id ?? '').toString();
          if (label){
            const spr = makeLabelSprite(label, n.labelAttr||{});
            spr.position.set(p[0], p[1], p[2]);
            spr.position.y += 6;
            labelGroup.add(spr);
          }
        }
      }

      if (Array.isArray(data?.edges)){
        const matLine = new THREE.LineBasicMaterial({color:0x88ffbb, transparent:true, opacity:.8});
        for (const e of data.edges){
          const a = mapPos.get(e.source), b = mapPos.get(e.target);
          if (!a || !b) continue;
          const geo = new THREE.BufferGeometry().setFromPoints([a,b]);
          const line = new THREE.Line(geo, matLine);
          edgeGroup.add(line);
        }
      }

      // Meta / counts 表示
      showMeta(data?.meta||{}, data);

      // ノードにフィット → これをホームとして記憶
      fitCameraToNodes(data?.nodes||[]);
      rememberHomeFromCurrentView();
      saveLayers(); // 現在値を保存（初回）
    }

    function showMeta(meta={}, data={}){
      const title = meta.title || '—';
      $metaTitle.textContent = title;

      const cn = Array.isArray(data.nodes) ? data.nodes.length : 0;
      const ce = Array.isArray(data.edges) ? data.edges.length : 0;
      $cn('count-nodes').textContent = String(cn);
      $cn('count-edges').textContent = String(ce);
      $counts.textContent = ` nodes:${cn} | edges:${ce}`;
    }

    /******************************************************************
     * Layers toggle + persistence
     ******************************************************************/
    const LAYERS_KEYS = ['nodes','edges','labels','aux'];
    function loadLayers(){
      try{
        const raw = localStorage.getItem(NS+'layers');
        if (!raw) return;
        const v = JSON.parse(raw);
        LAYERS_KEYS.forEach(k=>{
          if (k in v){
            const el = $cn('toggle-'+k);
            if (el){ el.checked = !!v[k]; }
            if (k==='nodes') nodeGroup.visible = !!v[k];
            if (k==='edges') edgeGroup.visible = !!v[k];
            if (k==='labels') labelGroup.visible = !!v[k];
            if (k==='aux') auxiliaryGroup.visible = !!v[k];
          }
        });
      }catch(_){}
    }
    function saveLayers(){
      const v = {
        nodes: !!$cn('toggle-nodes')?.checked,
        edges: !!$cn('toggle-edges')?.checked,
        labels:!!$cn('toggle-labels')?.checked,
        aux:   !!$cn('toggle-aux')?.checked
      };
      try{ localStorage.setItem(NS+'layers', JSON.stringify(v)); }catch(_){}
    }
    // wire toggles
    $cn('toggle-nodes').addEventListener('change', e=>{ nodeGroup.visible = e.target.checked; saveLayers(); });
    $cn('toggle-edges').addEventListener('change', e=>{ edgeGroup.visible = e.target.checked; saveLayers(); });
    $cn('toggle-labels').addEventListener('change', e=>{ labelGroup.visible = e.target.checked; saveLayers(); });
    $cn('toggle-aux')  .addEventListener('change', e=>{ auxiliaryGroup.visible = e.target.checked; saveLayers(); });

    /******************************************************************
     * UI: lang, fit, reset, select
     ******************************************************************/
    let currentData = null;
    document.getElementById('btnFit').addEventListener('click', ()=>{
      if (currentData) fitCameraToNodes(currentData.nodes);
      else fitCameraToScene();
    });
    document.getElementById('btnReset').addEventListener('click', resetView);

    // 言語切替（ダミー・ボタン表示だけ切替）
    const btnLang = document.getElementById('btnLang');
    btnLang.addEventListener('click', ()=>{
      const now = btnLang.textContent.trim();
      const next = now==='日本語' ? 'English' : '日本語';
      btnLang.textContent = next;
      try{ localStorage.setItem(NS+'lang', next); }catch(_){}
    });
    (function initLang(){
      const v = localStorage.getItem(NS+'lang');
      if (v) btnLang.textContent = v;
    })();

    const select = document.getElementById('fileSelect');
    select.addEventListener('change', async ()=>{
      if (!select.value) return;
      try{
        const data = await loadDigidiorama(select.value);
        currentData = data;
        runValidation(data);
        buildScene(data);
        try{ localStorage.setItem(NS+'lastFile', select.value); }catch(_){}
      }catch(err){
        console.error(err);
        $msg.textContent = '✖ ' + err.message;
      }
    });

    /******************************************************************
     * Bootstrap
     ******************************************************************/
    async function bootstrap(){
      resize();
      await loadSchemas().catch(()=>{});
      // manifest から select を構築
      let items = [];
      try{
        const mani = await loadManifest();
        if (validateManifest && !validateManifest(mani)){
          console.warn('manifest validation errors', validateManifest.errors);
        }
        // manifest { groups:[{title, files:[{path,title}]}] }
        mani.groups?.forEach(g=>{
          (g.files||[]).forEach(f=>{
            items.push({ path:f.path, title:f.title || f.path });
          });
        });
      }catch(_){
        // フォールバック（smoke test のみ）
        items = [
          { path:'./assets/data/smoke_test.json', title:'Smoke Test' }
        ];
      }
      // select構築
      select.innerHTML = '';
      for (const it of items){
        const opt = document.createElement('option');
        opt.value = it.path;
        opt.textContent = it.title;
        select.appendChild(opt);
      }

      // 直近の選択を復元
      const last = localStorage.getItem(NS+'lastFile');
      if (last && items.some(i=>i.path===last)) select.value = last;

      // レイヤー復元
      loadLayers();

      // 最初のロード
      if (select.value) select.dispatchEvent(new Event('change'));
      else if (items[0]){ select.value = items[0].path; select.dispatchEvent(new Event('change')); }

      animate();
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    bootstrap();
  </script>
</body>
</html>
