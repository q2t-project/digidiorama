<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Digidiorama Viewer v2</title>
  <base href="/digidiorama/">
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml;utf8,
      <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
        <circle cx='50' cy='50' r='45' stroke='black' stroke-width='5' fill='white'/>
        <text x='50' y='60' font-size='50' text-anchor='middle' fill='black'>D</text>
      </svg>">
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #container { display: flex; height: calc(100% - 60px); }
    #leftPanel, #rightPanel {
      width: 220px; overflow-y: auto; background: #f0f0f0; padding: 8px;
    }
    #viewer { flex: 1; background: #000; position: relative; }
    header { display: flex; align-items: center; gap: 8px; padding: 4px; background: #ddd; }
    footer { padding: 4px; background: #eee; font-size: 12px; text-align: center; }
    button { margin-right: 4px; }
    .label {
      font-size: 12px;
      color: white;
      -webkit-text-stroke: 2px black;
      text-stroke: 2px black;
      white-space: nowrap;
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <header>
    <select id="fileSelect"></select>
    <button id="resetBtn">Reset</button>
    <button id="fitBtn">Fit</button>
  </header>
  <div id="container">
    <div id="leftPanel">
      <h3>Meta</h3>
      <pre id="metaInfo"></pre>
    </div>
    <div id="viewer"></div>
    <div id="rightPanel">
      <h3>Layers</h3>
      <div id="layers"></div>
    </div>
  </div>
  <footer>
    schema v2 • 2025-09-25
  </footer>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import { CSS2DRenderer, CSS2DObject } from "three/addons/renderers/CSS2DRenderer.js";

    const container = document.getElementById("viewer");
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(container.clientWidth, container.clientHeight);
    labelRenderer.domElement.style.position = "absolute";
    labelRenderer.domElement.style.top = 0;
    labelRenderer.domElement.style.pointerEvents = "none";
    container.appendChild(labelRenderer.domElement);

    const controls = new OrbitControls(camera, labelRenderer.domElement);
    camera.position.set(0,0,100);
    controls.update();

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(1,1,1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    let graph = {nodes:[], edges:[]};

    function makeLabelPlane(text, attr={}) {
      const div = document.createElement("div");
      div.className = "label";
      div.textContent = text;
      if(attr.background){
        div.style.background = attr.background;
      }
      const label = new CSS2DObject(div);
      return label;
    }

    function loadJSON(data){
      graph = data;
      // counts表示
      const metaInfo = document.getElementById("metaInfo");
      const counts = `Nodes: ${data.nodes.length}\nEdges: ${data.edges.length}`;
      metaInfo.textContent = JSON.stringify(data.meta, null, 2) + "\n" + counts;

      // clear scene except lights
      [...scene.children].forEach(o=>{
        if(!(o.isLight)) scene.remove(o);
      });
      const nodeMap = new Map();
      data.nodes.forEach(n=>{
        const geom = new THREE.SphereGeometry(1.5,16,16);
        const mat = new THREE.MeshPhongMaterial({color:0x3399ff});
        const mesh = new THREE.Mesh(geom,mat);
        mesh.position.set(...n.pos);
        scene.add(mesh);

        if(n.label){
          const label = makeLabelPlane(n.label, n.labelAttr||{});
          label.position.copy(mesh.position).add(new THREE.Vector3(2,2,0));
          scene.add(label);
        }
        nodeMap.set(n.id, mesh);
      });

      data.edges.forEach(e=>{
        const src = nodeMap.get(e.source);
        const tgt = nodeMap.get(e.target);
        if(src && tgt){
          const pts = [src.position, tgt.position];
          const geom = new THREE.BufferGeometry().setFromPoints(pts);
          const mat = new THREE.LineBasicMaterial({color:0x999999});
          const line = new THREE.Line(geom, mat);
          scene.add(line);
        }
      });

      // レイヤー構築
      buildLayersUI(data);
    }

    function buildLayersUI(data){
      const layersDiv = document.getElementById("layers");
      layersDiv.innerHTML = "";
      const key = "ddv:v2:layers";
      let state = {};
      try{
        state = JSON.parse(localStorage.getItem(key)) || {};
      }catch{}
      data.auxiliary?.forEach(layer=>{
        const id = "layer_" + layer.id;
        const chk = document.createElement("input");
        chk.type = "checkbox";
        chk.id = id;
        chk.checked = state[layer.id] !== false;
        chk.addEventListener("change", ()=>{
          state[layer.id] = chk.checked;
          localStorage.setItem(key, JSON.stringify(state));
          // TODO: toggle layer visibility
        });
        const lbl = document.createElement("label");
        lbl.htmlFor = id;
        lbl.textContent = layer.label || layer.id;
        const div = document.createElement("div");
        div.appendChild(chk);
        div.appendChild(lbl);
        layersDiv.appendChild(div);
      });
    }

    async function loadManifest(){
      try {
        const res = await fetch("./assets/manifest.json");
        if(!res.ok) throw new Error("Manifest load failed");
        return res.json();
      } catch(err){
        console.error("Manifest error:", err);
        return { groups: [] };
      }
    }

    async function loadDigidiorama(path){
      try {
        const res = await fetch(path);
        if(!res.ok) throw new Error("Data load failed");
        return res.json();
      } catch(err){
        console.error("Data load error:", err);
        return { meta:{title:"Error"}, nodes:[], edges:[], auxiliary:[] };
      }
    }

    const select=document.getElementById("fileSelect");
    loadManifest().then(list=>{
      list.groups.forEach(group=>{
        const optgroup=document.createElement("optgroup");
        optgroup.label=group.title;
        group.files.forEach(f=>{
          const opt=document.createElement("option");
          opt.value=f.path;
          opt.textContent=f.title;
          optgroup.appendChild(opt);
        });
        select.appendChild(optgroup);
      });
      if(select.options.length>0){
        select.selectedIndex=0;
        loadDigidiorama(select.value).then(loadJSON);
      }
    });

    select.addEventListener("change",()=>{
      const val=select.value;
      if(val) loadDigidiorama(val).then(loadJSON);
    });

    // Reset button
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      camera.position.set(0,0,100);
      controls.reset();
    });

    // Fit button
    document.getElementById("fitBtn").addEventListener("click", ()=>{
      const box = new THREE.Box3().setFromObject(scene);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());
      camera.position.copy(center);
      camera.position.z += size*1.2;
      controls.target.copy(center);
      controls.update();
    });
    window.addEventListener("resize", ()=>{
      camera.aspect = container.clientWidth/container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
      labelRenderer.setSize(container.clientWidth, container.clientHeight);
    });

    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }
    animate();

    // ============================
    // i18n（国際化対応の雛形）
    // ============================
    const i18nStrings = {
      ja: {
        reset: "リセット",
        fit: "フィット",
        meta: "メタ情報",
        layers: "レイヤー"
      },
      en: {
        reset: "Reset",
        fit: "Fit",
        meta: "Meta Info",
        layers: "Layers"
      }
    };

    function applyI18n(lang){
      document.getElementById("resetBtn").textContent = i18nStrings[lang].reset;
      document.getElementById("fitBtn").textContent = i18nStrings[lang].fit;
      document.querySelector("#leftPanel h3").textContent = i18nStrings[lang].meta;
      document.querySelector("#rightPanel h3").textContent = i18nStrings[lang].layers;
    }

    // デフォルトは日本語
    applyI18n("ja");

    // ============================
    // JSON Schema Validation (AJV)
    // ============================
    import Ajv from "https://cdn.jsdelivr.net/npm/ajv@8.12.0/dist/ajv7.min.js";

    async function validateJSON(data){
      try{
        const res = await fetch("./assets/digidiorama.schema.json");
        if(!res.ok) throw new Error("schema load failed");
        const schema = await res.json();
        const ajv = new Ajv();
        const validate = ajv.compile(schema);
        const valid = validate(data);
        if(!valid){
          console.warn("Validation errors:", validate.errors);
        }
        return valid;
      }catch(err){
        console.error("Validation error:", err);
        return false;
      }
    }

    // ============================
    // ファイルアップロード機能
    // ============================
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = ".json";
    fileInput.style.display = "none";
    document.body.appendChild(fileInput);

    const uploadBtn = document.createElement("button");
    uploadBtn.textContent = "Upload JSON";
    document.querySelector("header").appendChild(uploadBtn);

    uploadBtn.addEventListener("click", ()=> fileInput.click());
    fileInput.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (ev)=>{
          try{
            const data = JSON.parse(ev.target.result);
            validateJSON(data).then(valid=>{
              if(valid){
                loadJSON(data);
              }else{
                alert("JSON validation failed. See console.");
              }
            });
          }catch(err){
            alert("Invalid JSON: " + err.message);
          }
        };
        reader.readAsText(file);
      }
    });

    // ============================
    // JSON URL入力機能
    // ============================
    const urlInput = document.createElement("input");
    urlInput.type = "text";
    urlInput.placeholder = "JSON URLを入力";
    document.querySelector("header").appendChild(urlInput);

    const loadBtn = document.createElement("button");
    loadBtn.textContent = "Load URL";
    document.querySelector("header").appendChild(loadBtn);

    loadBtn.addEventListener("click", ()=>{
      const url = urlInput.value.trim();
      if(url){
        loadDigidiorama(url).then(data=>{
          validateJSON(data).then(valid=>{
            if(valid){
              loadJSON(data);
            }else{
              alert("JSON validation failed. See console.");
            }
          });
        });
      }
    });
    // ============================
    // デバッグ用: コンソール操作
    // ============================
    window.ddv = {
      scene,
      camera,
      controls,
      loadDigidiorama,
      loadJSON
    };

    console.log("Digidiorama Viewer v2 loaded");

  </script>
</body>
</html>
