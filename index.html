<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>digidiorama viewer</title>
  <style>
    :root { --bg: #0b1020; --fg: #e6edf3; --accent: #5aa9ff; --panel:#10172c; --border:#1d2748; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;background:#0e142a;border-bottom:1px solid var(--border)}
    header h1{font-size:14px;font-weight:600;margin:0;letter-spacing:.3px}
    header .spacer{flex:1}
    header select, header button{appearance:none;border:1px solid #2a3969;background:#131a33;color:var(--fg);padding:.35rem .6rem;border-radius:.4rem;cursor:pointer}
    header button:hover, header select:hover{border-color:#39529c;background:#1a2347}
    #main{display:grid;grid-template-columns:1fr 280px;overflow:hidden}
    #viewer{position:relative;overflow:hidden}
    #panel{background:var(--panel);border-left:1px solid var(--border);padding:.6rem .6rem;overflow-y:auto}
    #panel h2{font-size:13px;margin:.5rem 0}
    #panel .meta-item, #panel .error-item, #panel .node-item{font-size:12px;margin-bottom:.25rem;white-space:pre-wrap;word-break:break-word}
    .credit{position:absolute;right:.5rem;bottom:.5rem;font-size:11px;opacity:.7}
    canvas{display:block;width:100%;height:100%;}
    #layersMenu{position:relative}
    #layersDropdown{display:none;position:absolute;right:0;top:100%;background:#131a33;border:1px solid #2a3969;padding:.5rem;border-radius:.4rem;z-index:20}
    #layersDropdown label{display:block;font-size:12px;margin:.15rem 0}
    @media(max-width:720px){
      #main{grid-template-columns:1fr;}
      #panel{display:none;position:absolute;top:0;right:0;width:78%;height:100%;z-index:10}
      #panel.open{display:block;background:#0b1020}
      #fab{position:absolute;right:.75rem;bottom:.75rem;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:20px;cursor:pointer;z-index:30}
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "ajv": "https://cdn.skypack.dev/ajv@8"
      }
    }
  </script>
</head>
<body>
  <div id="app">
    <header>
      <h1 data-i18n="title">デジジオラマ</h1>
      <div class="spacer"></div>
      <select id="fileSelect" title="manifest.json から読み込み"></select>
      <select id="langSelect">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
      <button id="btnReset" data-i18n="reset">Reset</button>
      <div id="layersMenu">
        <button id="btnLayers" data-i18n="layers">Layers ▼</button>
        <div id="layersDropdown">
          <label><input type="checkbox" id="toggle-nodes" checked /> Nodes</label>
          <label><input type="checkbox" id="toggle-edges" checked /> Edges</label>
          <label><input type="checkbox" id="toggle-labels" checked /> Labels</label>
          <label><input type="checkbox" id="toggle-grids" checked /> Grids</label>
          <label><input type="checkbox" id="toggle-aux" checked /> Auxiliary</label>
        </div>
      </div>
    </header>
    <div id="main">
      <div id="viewer"></div>
      <div id="panel">
        <h2 data-i18n="meta">Meta</h2>
        <div id="meta"></div>
        <div id="counts"></div>
        <h2 data-i18n="node">Node</h2>
        <div id="node"></div>
        <h2 data-i18n="errors">Errors</h2>
        <div id="errors"></div>
      </div>
    </div>
    <button id="fab" title="Panel">≡</button>
  </div>
  <div class="credit">MIT © q2t-project / Content © respective authors</div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import Ajv from 'ajv';

    // ===== Core =====
    const container=document.getElementById('viewer');
    const scene=new THREE.Scene();scene.background=new THREE.Color(0x0b1020);

    const camera=new THREE.PerspectiveCamera(60,1,0.1,1000);
    camera.up.set(0,0,1);
    const renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    container.appendChild(renderer.domElement);

    const controls=new OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;
    controls.zoomSpeed = 2;
    controls.minDistance = 0.2;
    controls.maxDistance = 500;
    controls.update();
    controls.addEventListener('change', ()=>renderer.render(scene,camera));

    scene.add(new THREE.AmbientLight(0xffffff,0.65));
    const dir=new THREE.DirectionalLight(0xffffff,0.8);dir.position.set(5,10,7);scene.add(dir);

    // ===== Groups =====
    const nodeGroup=new THREE.Group();
    const edgeGroup=new THREE.Group();
    const labelGroup=new THREE.Group();
    const gridGroup=new THREE.Group();
    const auxGroup=new THREE.Group();   // auxiliary用グループ
    scene.add(edgeGroup,nodeGroup,labelGroup,gridGroup,auxGroup);

    // ===== Data state =====
    const nodeById=new Map();
    let currentData=null;

    // ===== Labels =====
    function makeLabelPlane(text, options={}, nodeId=null){
      const fontSize=options.fontSize??28;
      const fontFamily=options.fontFamily??"Arial";
      const color=options.color??"white";
      const opacity=options.opacity??1.0;
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      ctx.font=`${fontSize}px ${fontFamily}`;
      const metrics=ctx.measureText(text);
      canvas.width=Math.max(2,Math.ceil(metrics.width+20));
      canvas.height=Math.max(2,Math.ceil(fontSize*1.6));
      ctx.font=`${fontSize}px ${fontFamily}`;
      ctx.fillStyle=color;
      ctx.textAlign="center";ctx.textBaseline="middle";
      ctx.fillText(text,canvas.width/2,canvas.height/2);
      const texture=new THREE.CanvasTexture(canvas);
      const mat=new THREE.MeshBasicMaterial({map:texture,transparent:true,opacity,side:THREE.DoubleSide});
      const geom=new THREE.PlaneGeometry(canvas.width*0.01,canvas.height*0.01);
      const mesh=new THREE.Mesh(geom,mat);
      if(nodeId) mesh.userData.nodeId=nodeId;
      return mesh;
    }

    // ===== Auxiliary =====
    function addAuxiliary(a){
      switch(a.type){
        case "axis":
          const axes=new THREE.AxesHelper(a.length??1);
          if(a.position) axes.position.set(...a.position);
          auxGroup.add(axes);break;
        case "grid":
          const size=a.size??1;
          const div=a.divisions??10;
          const grid=new THREE.GridHelper(size,div,a.color??0x444444,a.color??0x444444);
          grid.material.opacity=a.opacity??0.3;
          grid.material.transparent=true;
          if(a.position) grid.position.set(...a.position);
          auxGroup.add(grid);break;
        case "text":
          const label=makeLabelPlane(a.text??"",a);
          if(a.position) label.position.set(...a.position);
          auxGroup.add(label);break;
      }
    }

    // ===== Build Scene =====
    function buildScene(data){
      currentData=data;
      nodeGroup.clear();edgeGroup.clear();labelGroup.clear();gridGroup.clear();auxGroup.clear();nodeById.clear();
      const sphere=new THREE.SphereGeometry(0.05,16,16);

      for(const n of data.nodes||[]){
        const mat=new THREE.MeshBasicMaterial({color:n.nodeAttr?.color??0xaaaaaa});
        const m=new THREE.Mesh(sphere,mat);
        m.position.set(...n.position);
        m.userData=n;
        nodeGroup.add(m);nodeById.set(n.id,m);
        if(n.label){m.add(makeLabelPlane(n.label,n.labelAttr,n.id));}
      }

      for(const e of data.edges||[]){
        const a=nodeById.get(e.source),b=nodeById.get(e.target);if(!a||!b)continue;
        const geo=new THREE.BufferGeometry().setFromPoints([a.position,b.position]);
        const mat=new THREE.LineBasicMaterial({color:e.color||0x9ec1ff});
        edgeGroup.add(new THREE.Line(geo,mat));
      }

      for(const a of data.auxiliary||[]){addAuxiliary(a);}  // auxiliary処理

      renderer.render(scene,camera);
    }

    // ===== UI: toggles =====
    const elLayersBtn=document.getElementById('btnLayers');
    const elLayersDrop=document.getElementById('layersDropdown');
    elLayersBtn.addEventListener('click',()=>{elLayersDrop.style.display=(elLayersDrop.style.display==='block'?'none':'block');});
    document.getElementById('toggle-nodes').addEventListener('change',e=>{nodeGroup.visible=e.target.checked;renderer.render(scene,camera);});
    document.getElementById('toggle-edges').addEventListener('change',e=>{edgeGroup.visible=e.target.checked;renderer.render(scene,camera);});
    document.getElementById('toggle-labels').addEventListener('change',e=>{labelGroup.visible=e.target.checked;renderer.render(scene,camera);});
    document.getElementById('toggle-grids').addEventListener('change',e=>{gridGroup.visible=e.target.checked;renderer.render(scene,camera);});
    document.getElementById('toggle-aux').addEventListener('change',e=>{auxGroup.visible=e.target.checked;renderer.render(scene,camera);});

    // ===== DataAccess =====
    const fileSelect=document.getElementById('fileSelect');
    async function loadManifest(){
    try{
      const res = await fetch('./assets/manifest.json', {cache:'no-cache'});
      if(!res.ok) throw new Error(`manifest load failed: ${res.status}`);
      const mani = await res.json();
      // どの形でも受けられるように正規化
      const files = Array.isArray(mani)        ? mani
                   : Array.isArray(mani.files) ? mani.files
                   : Array.isArray(mani.items) ? mani.items
                   : null;
      if(!files || files.length===0) throw new Error('manifest has no files[]');
 
      fileSelect.innerHTML = files
        .map(f => `<option value="${f.path}">${f.label ?? f.path}</option>`)
        .join('');
 
      const urlFile = new URLSearchParams(location.search).get('file');
      const initial = urlFile || files[0].path;
      fileSelect.value = initial;
      await loadJSON(initial);
    }catch(err){
      console.warn(err);
     const box = document.getElementById('errors');
      if (box) box.textContent = String(err);
      // フォールバック（manifest が無い/壊れている場合）
      fileSelect.innerHTML =
        `<option value="./assets/data/sample_with_auxiliary.json">sample_with_auxiliary.json</option>`;
      await loadJSON('./assets/data/sample_with_auxiliary.json');
    }
  }
    async function loadJSON(path){
      const res=await fetch(path);const data=await res.json();
      buildScene(data);
    }
    fileSelect.addEventListener('change',async e=>{await loadJSON(e.target.value);});

    // ===== Boot =====
    function onResize(){const w=container.clientWidth,h=container.clientHeight;renderer.setSize(w,h,false);camera.aspect=w/h;camera.updateProjectionMatrix();}
    window.addEventListener('resize',onResize);
    (async function boot(){onResize();await loadManifest();})();
  </script>
</body>
</html>
